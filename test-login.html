<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Login - Emacs Website</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="window">
        <div class="buffer active">
            <div class="buffer-content" style="max-width: 600px; margin: 40px auto;">
                <h1 style="color: var(--cyan); margin-bottom: 20px;">;; Login Debugger</h1>

                <div style="background: var(--bg-dim); padding: 20px; margin-bottom: 20px; border-left: 3px solid var(--yellow);">
                    <div style="color: var(--yellow); font-weight: bold; margin-bottom: 10px;">⚠ Common Issues:</div>
                    <ul style="color: var(--fg-dim); font-size: 13px; line-height: 1.8;">
                        <li>Email must have @ symbol: <span style="color: var(--green);">jaganat@mail.com</span> ✓</li>
                        <li>NOT: <span style="color: var(--red);">jaganatmail.com</span> ✗</li>
                        <li>Account must exist - register first if new</li>
                        <li>Password is case-sensitive</li>
                    </ul>
                </div>

                <div style="margin-bottom: 15px;">
                    <label style="color: var(--fg-main); display: block; margin-bottom: 5px; font-size: 13px;">
                        Email:
                    </label>
                    <input type="email" id="test-email" style="
                        width: 100%;
                        background: var(--bg-main);
                        border: 1px solid var(--bg-active);
                        color: var(--fg-main);
                        padding: 10px;
                        font-family: inherit;
                        font-size: 14px;
                    " placeholder="jaganat@mail.com" value="jaganat@mail.com" autofocus>
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="color: var(--fg-main); display: block; margin-bottom: 5px; font-size: 13px;">
                        Password:
                    </label>
                    <input type="password" id="test-password" style="
                        width: 100%;
                        background: var(--bg-main);
                        border: 1px solid var(--bg-active);
                        color: var(--fg-main);
                        padding: 10px;
                        font-family: inherit;
                        font-size: 14px;
                    " placeholder="Emacs108" value="Emacs108">
                </div>

                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button id="test-login-btn" style="
                        flex: 1;
                        background: var(--cyan);
                        color: var(--bg-main);
                        border: none;
                        padding: 12px;
                        font-family: inherit;
                        font-size: 14px;
                        font-weight: bold;
                        cursor: pointer;
                    ">Test Login</button>

                    <button id="register-btn" style="
                        flex: 1;
                        background: var(--green);
                        color: var(--bg-main);
                        border: none;
                        padding: 12px;
                        font-family: inherit;
                        font-size: 14px;
                        font-weight: bold;
                        cursor: pointer;
                    ">Register This Account</button>
                </div>

                <div id="result" style="
                    padding: 15px;
                    font-size: 13px;
                    display: none;
                    border-radius: 4px;
                    margin-bottom: 15px;
                    white-space: pre-wrap;
                    font-family: monospace;
                "></div>

                <div style="text-align: center; margin-top: 30px;">
                    <a href="/" style="color: var(--cyan);">← Back to Home</a>
                </div>
            </div>
        </div>
    </div>

    <div class="mode-line">
        <span class="mode-line-buffer" style="color: var(--cyan);">*Test-Login*</span>
        <span class="mode-line-separator">--</span>
        <span class="mode-line-mode">Fundamental</span>
    </div>

    <script>
        const API_URL = 'https://emacs-website.joanmanelferrera-400.workers.dev';

        function showResult(message, isError = false) {
            const resultDiv = document.getElementById('result');
            resultDiv.textContent = message;
            resultDiv.style.display = 'block';
            if (isError) {
                resultDiv.style.background = 'rgba(255, 95, 89, 0.2)';
                resultDiv.style.border = '2px solid #ff5f59';
                resultDiv.style.color = '#ff5f59';
            } else {
                resultDiv.style.background = 'rgba(68, 188, 68, 0.2)';
                resultDiv.style.border = '2px solid #44bc44';
                resultDiv.style.color = '#44bc44';
            }
        }

        // Test login
        document.getElementById('test-login-btn').addEventListener('click', async () => {
            const email = document.getElementById('test-email').value.trim();
            const password = document.getElementById('test-password').value.trim();

            // Check email format
            if (!email.includes('@')) {
                showResult('✗ ERROR: Email must contain @ symbol\n\nYou entered: ' + email + '\nShould be: jaganat@mail.com', true);
                return;
            }

            showResult('Testing login...');

            try {
                const response = await fetch(`${API_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: email, password: password })
                });

                const data = await response.json();

                if (response.ok) {
                    localStorage.setItem('emacs-website-token', data.token);
                    localStorage.setItem('emacs-website-username', data.username);
                    showResult('✓ SUCCESS!\n\nLogged in as: ' + data.username + '\n\nRedirecting to home...', false);
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 2000);
                } else {
                    let errorMsg = '✗ LOGIN FAILED\n\n';
                    errorMsg += 'Email: ' + email + '\n';
                    errorMsg += 'Error: ' + (data.error || 'Unknown error') + '\n\n';

                    if (data.error === 'Invalid username or password') {
                        errorMsg += 'Possible reasons:\n';
                        errorMsg += '1. Account does not exist - click "Register This Account"\n';
                        errorMsg += '2. Wrong password\n';
                        errorMsg += '3. Email typo (check @ symbol)\n';
                    }

                    showResult(errorMsg, true);
                }
            } catch (error) {
                showResult('✗ NETWORK ERROR\n\n' + error.message, true);
            }
        });

        // Register account
        document.getElementById('register-btn').addEventListener('click', async () => {
            const email = document.getElementById('test-email').value.trim();
            const password = document.getElementById('test-password').value.trim();

            if (!email.includes('@')) {
                showResult('✗ ERROR: Email must contain @ symbol\n\nYou entered: ' + email + '\nShould be: jaganat@mail.com', true);
                return;
            }

            if (password.length < 6) {
                showResult('✗ ERROR: Password must be at least 6 characters', true);
                return;
            }

            showResult('Creating account...');

            try {
                const response = await fetch(`${API_URL}/api/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: email, password: password })
                });

                const data = await response.json();

                if (response.ok) {
                    showResult('✓ ACCOUNT CREATED!\n\nEmail: ' + email + '\nPassword: ' + password + '\n\nNow click "Test Login" to login', false);
                } else {
                    let errorMsg = '✗ REGISTRATION FAILED\n\n';
                    errorMsg += 'Email: ' + email + '\n';
                    errorMsg += 'Error: ' + (data.error || 'Unknown error') + '\n\n';

                    if (data.error === 'Username already taken') {
                        errorMsg += 'This account already exists!\n';
                        errorMsg += 'Click "Test Login" to login instead.\n';
                    }

                    showResult(errorMsg, true);
                }
            } catch (error) {
                showResult('✗ NETWORK ERROR\n\n' + error.message, true);
            }
        });

        // Allow Enter to test login
        document.getElementById('test-password').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('test-login-btn').click();
            }
        });
    </script>
</body>
</html>
